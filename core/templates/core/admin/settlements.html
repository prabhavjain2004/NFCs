{% extends 'core/base.html' %}
{% load static %}

{% block title %}Settlement Management - NFC Payment System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">Settlements</h1>
    <!-- Settlement Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-blue-600 text-white rounded-lg shadow-lg">
            <div class="p-6">
                <h5 class="text-lg font-medium mb-2">Total Pending Settlements</h5>
                <h2 id="pendingSettlements" class="text-3xl font-bold">0</h2>
                <small>Value: ₹<span id="pendingValue">0.00</span></small>
            </div>
        </div>
        <div class="bg-green-600 text-white rounded-lg shadow-lg">
            <div class="p-6">
                <h5 class="text-lg font-medium mb-2">Completed Today</h5>
                <h2 id="completedToday" class="text-3xl font-bold">0</h2>
                <small>Value: ₹<span id="completedValue">0.00</span></small>
            </div>
        </div>
        <div class="bg-blue-500 text-white rounded-lg shadow-lg">
            <div class="p-6">
                <h5 class="text-lg font-medium mb-2">Total Outlets</h5>
                <h2 id="totalOutlets" class="text-3xl font-bold">0</h2>
                <small>With pending settlements: <span id="outletsWithPending">0</span></small>
            </div>
        </div>
    </div>

    <!-- Settlements Table -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="bg-gray-700 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
            <h5 class="text-lg font-medium">Settlement Management</h5>
            <div class="flex space-x-2">
                <button class="bg-white text-gray-700 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100 active" data-filter="pending">Pending</button>
                <button class="bg-white text-gray-700 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100" data-filter="completed">Completed</button>
                <button class="bg-white text-gray-700 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100" data-filter="all">All</button>
            </div>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outlet</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transactions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Transaction</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="settlementsList" class="divide-y divide-gray-200">
                        <!-- Settlements will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Settlement Details Modal -->
<div class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center" id="settlementModal">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h5 class="text-lg font-medium text-gray-900">Settlement Details</h5>
            <button type="button" class="text-gray-400 hover:text-gray-500" data-dismiss="modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="outlet-info mb-6">
                <h6 class="text-lg font-medium text-gray-900 mb-4">Outlet Information</h6>
                <p class="mb-2"><strong>Name:</strong> <span id="outletName"></span></p>
                <p class="mb-2"><strong>Address:</strong> <span id="outletAddress"></span></p>
                <p class="mb-2"><strong>Contact:</strong> <span id="outletContact"></span></p>
            </div>
            <div class="settlement-transactions">
                <h6 class="text-lg font-medium text-gray-900 mb-4">Transactions to Settle</h6>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Card ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsList" class="divide-y divide-gray-200">
                        <!-- Transactions will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-4 rounded-b-lg">
            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300" data-dismiss="modal">Close</button>
            <button type="button" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" id="processSettlementBtn">Process Settlement</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSummary();
    loadSettlements('pending');
    setupEventListeners();
});

function loadSummary() {
    const token = localStorage.getItem('access_token');
    axios.get('/api/settlements/summary/', {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        document.getElementById('pendingSettlements').textContent = response.data.pending_count;
        document.getElementById('pendingValue').textContent = response.data.pending_amount;
        document.getElementById('completedToday').textContent = response.data.completed_today;
        document.getElementById('completedValue').textContent = response.data.completed_amount;
        document.getElementById('totalOutlets').textContent = response.data.total_outlets;
        document.getElementById('outletsWithPending').textContent = response.data.outlets_with_pending;
    })
    .catch(error => {
        console.error('Error loading summary:', error);
    });
}

function loadSettlements(filter = 'pending') {
    const token = localStorage.getItem('access_token');
    axios.get(`/api/settlements/?status=${filter}`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        const tbody = document.getElementById('settlementsList');
        tbody.innerHTML = '';
        response.data.forEach(settlement => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">${settlement.outlet.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${settlement.amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${settlement.transaction_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(settlement.last_transaction).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            settlement.status === 'completed' 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${settlement.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2" onclick="viewSettlement(${settlement.id})">
                            View
                        </button>
                        ${settlement.status === 'pending' ? `
                            <button class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600" onclick="processSettlement(${settlement.id})">
                                Process
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
    })
    .catch(error => {
        console.error('Error loading settlements:', error);
    });
}

function setupEventListeners() {
    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelector('[data-filter].active').classList.remove('active');
            e.target.classList.add('active');
            loadSettlements(e.target.dataset.filter);
        });
    });

    // Process settlement button in modal
    document.getElementById('processSettlementBtn').addEventListener('click', function() {
        const settlementId = this.dataset.settlementId;
        if (settlementId) {
            processSettlement(settlementId);
        }
    });
}

function viewSettlement(settlementId) {
    const token = localStorage.getItem('access_token');
    axios.get(`/api/settlements/${settlementId}/`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        const settlement = response.data;
        
        // Update outlet information
        document.getElementById('outletName').textContent = settlement.outlet.name;
        document.getElementById('outletAddress').textContent = settlement.outlet.address;
        document.getElementById('outletContact').textContent = settlement.outlet.contact;

        // Update transactions list
        const tbody = document.getElementById('transactionsList');
        tbody.innerHTML = '';
        settlement.transactions.forEach(transaction => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(transaction.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${transaction.card_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">₹${transaction.amount}</td>
                </tr>
            `;
        });

        // Update process button
        const processBtn = document.getElementById('processSettlementBtn');
        processBtn.dataset.settlementId = settlementId;
        processBtn.style.display = settlement.status === 'pending' ? 'block' : 'none';

        // Show modal
        document.getElementById('settlementModal').classList.remove('hidden');
    })
    .catch(error => {
        console.error('Error loading settlement details:', error);
        alert('Failed to load settlement details');
    });
}

function processSettlement(settlementId) {
    const token = localStorage.getItem('access_token');
    axios.post(`/api/settlements/${settlementId}/process/`, {}, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(() => {
        document.getElementById('settlementModal').classList.add('hidden');
        loadSummary();
        loadSettlements(document.querySelector('[data-filter].active').dataset.filter);
    })
    .catch(error => {
        console.error('Error processing settlement:', error);
        alert('Failed to process settlement');
    });
}
</script>
{% endblock %}
