{% extends 'base.html' %}
{% load static %}

{% block title %}User Management - NFC Payment System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-lg">
        <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
            <h5 class="text-lg font-medium">User Management</h5>
            <button class="bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100" id="addUserBtn">
                <i class="fas fa-plus mr-1"></i> Add User
            </button>
        </div>
        <div class="p-6">
            <!-- User Filters -->
            <div class="mb-6">
                <div class="flex space-x-2">
                    <button class="px-4 py-2 border-2 border-blue-600 text-blue-600 rounded hover:bg-blue-50 active" data-filter="all">All Users</button>
                    <button class="px-4 py-2 border-2 border-blue-600 text-blue-600 rounded hover:bg-blue-50" data-filter="customer">Customers</button>
                    <button class="px-4 py-2 border-2 border-blue-600 text-blue-600 rounded hover:bg-blue-50" data-filter="outlet">Outlets</button>
                </div>
            </div>

            <!-- Users Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList" class="divide-y divide-gray-200">
                        <!-- Users will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center" id="userModal">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h5 class="text-lg font-medium text-gray-900">Add User</h5>
            <button type="button" class="text-gray-400 hover:text-gray-500" data-dismiss="modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="userForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User Type</label>
                    <select class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="userType" required>
                        <option value="customer">Customer</option>
                        <option value="outlet">Outlet</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="username" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="email" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="password" required>
                </div>
                <div id="outletFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Outlet Name</label>
                        <input type="text" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="outletName">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <textarea class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" id="address"></textarea>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Save User</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    setupEventListeners();
});

function loadUsers(filter = 'all') {
    const token = localStorage.getItem('access_token');
    axios.get(`/api/users/?type=${filter}`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        const tbody = document.getElementById('usersList');
        tbody.innerHTML = '';
        response.data.forEach(user => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.user_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            user.is_active 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2" onclick="editUser(${user.id})">
                            Edit
                        </button>
                        <button class="px-3 py-1 ${user.is_active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded" 
                                onclick="toggleUserStatus(${user.id}, ${user.is_active})">
                            ${user.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                </tr>
            `;
        });
    })
    .catch(error => {
        console.error('Error loading users:', error);
    });
}

function setupEventListeners() {
    // Filter buttons
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelector('[data-filter].active').classList.remove('active');
            e.target.classList.add('active');
            loadUsers(e.target.dataset.filter);
        });
    });

    // User type selection
    document.getElementById('userType').addEventListener('change', (e) => {
        const outletFields = document.getElementById('outletFields');
        outletFields.style.display = e.target.value === 'outlet' ? 'block' : 'none';
    });

    // Add user button
    document.getElementById('addUserBtn').addEventListener('click', () => {
        document.getElementById('userForm').reset();
        document.querySelector('#userModal .modal-title').textContent = 'Add User';
        document.getElementById('userModal').classList.remove('hidden');
    });

    // User form submission
    document.getElementById('userForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            user_type: document.getElementById('userType').value
        };

        if (formData.user_type === 'outlet') {
            formData.outlet_name = document.getElementById('outletName').value;
            formData.address = document.getElementById('address').value;
        }

        const token = localStorage.getItem('access_token');
        axios.post('/api/users/', formData, {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(() => {
            document.getElementById('userModal').classList.add('hidden');
            loadUsers();
        })
        .catch(error => {
            console.error('Error saving user:', error);
            alert('Failed to save user');
        });
    });
}

function editUser(userId) {
    const token = localStorage.getItem('access_token');
    axios.get(`/api/users/${userId}/`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => {
        const user = response.data;
        document.getElementById('username').value = user.username;
        document.getElementById('email').value = user.email;
        document.getElementById('userType').value = user.user_type;
        
        if (user.user_type === 'outlet') {
            document.getElementById('outletName').value = user.outlet?.name || '';
            document.getElementById('address').value = user.outlet?.address || '';
            document.getElementById('outletFields').style.display = 'block';
        } else {
            document.getElementById('outletFields').style.display = 'none';
        }

        document.querySelector('#userModal .modal-title').textContent = 'Edit User';
        document.getElementById('userModal').classList.remove('hidden');
    })
    .catch(error => {
        console.error('Error loading user details:', error);
        alert('Failed to load user details');
    });
}

function toggleUserStatus(userId, currentStatus) {
    const token = localStorage.getItem('access_token');
    axios.post(`/api/users/${userId}/toggle/`, {
        active: !currentStatus
    }, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(() => {
        loadUsers();
    })
    .catch(error => {
        console.error('Error toggling user status:', error);
        alert('Failed to update user status');
    });
}
</script>
{% endblock %}
